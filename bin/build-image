#!/usr/bin/env bash

# Copyright 2011, Joyent. Inc. All rights reserved.

set -o errexit
set -o pipefail

fatal() {
  printf "$(basename $0): fatal error: $*\n"
  exit 1
}

check_uname() {
  case `uname -s` in
    Darwin)
      ;;
    SunOS)
      ;;
    *)
      fatal "Not a supported Operating system. Try it on OSX or SmartOS"
      ;;
  esac
}

# check out all repositories we need to copy files from
get_latest() {
  echo "==> Getting latest files from git repositories"
  repositories=(vmadm windows)
  for i in ${repositories[@]} ; do 
    if [[ -d cache/$i/.git ]] ; then
      cd cache/$i
      git pull --rebase
      cd ../../
    else
      git clone git@git.joyent.com:$i.git cache/$i
    fi
  done
}

# copies the latest bits into the ISO layout
copy_latest() {
  echo "==> Copying files into layout"
  target=cache/iso/windows/
  files=(cache/windows/README.md cache/windows/lib cache/windows/bin \
    cache/windows/sysprep cache/windows/drivers cache/windows/install.bat)
  for i in ${files[@]} ; do
    if [[ -e ${i} ]] ; then
      cp -r ${i} $target
    else
      fatal "File '${i}' was not found"
    fi
  done
}

pack_iso() {
  echo "==> Creating ISO"
}
# ensure we're always in the right working directory
cd $(dirname $0)/../
echo "==> Starting ISO build"
check_uname
get_latest
copy_latest
pack_iso
echo "==> DONE"
exit 0
